<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Plant Watering Tracker</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #f0f0f0;
            --primary-color: #0a84ff;
            --surface-color: #0a0d0a;
            --border-color: #8f8f8f;
            --watered-color: #002060; /* Dark Blue */
			--fertilized-color: #046817;
            --session-change-color: #3399ff; /* Light Blue */
            --danger-color: #ff3b30;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        #menu-icon {
            font-size: 28px;
            padding: 15px;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1002;
        }
        
        #menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 200px;
            height: 100%;
            background-color: var(--surface-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            transition: left 0.3s ease;
            z-index: 1001;
            padding-top: 60px;
        }

        #menu.open {
            left: 0;
        }

        #menu a {
            display: block;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        #menu a:hover {
            background-color: var(--primary-color);
        }
        #menu a.active {
            background-color: var(--primary-color);
        }

        main {
            padding: 60px 15px 15px 15px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .page { display: none; }
        .page.active { display: block; }
        
        /* --- Plants Page --- */
        #plant-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plant-row, #add-plant-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 5px;
            background-color: var(--surface-color);
            border-radius: 5px;
        }

        .plant-row.dragging {
            opacity: 0.5;
            background: var(--primary-color);
        }

        .plant-name-input {
            flex-grow: 1;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }

        .plant-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }

        .reorder-handle { cursor: grab; }
        .reorder-handle:active { cursor: grabbing; }
        .delete-btn { color: var(--danger-color); }

        #add-plant-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        /* --- Calendar Page --- */
        #calendar-container {
            width: 100%;
            height: calc(100vh - 75px); /* Full viewport height minus top padding */
            overflow: auto; /* Enables both horizontal and vertical scrolling */
        }
        
        #calendar-table {
            border-collapse: collapse;
            ---width: 100%;
        }

        #calendar-table th, #calendar-table td {
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 0;
            height: 40px;
        }
		
		.plant-header-cell {
			
            height: 150px !important;
        }

        #calendar-table th {
            background-color: var(--surface-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .date-col {
            min-width: 70px;
            max-width: 70px;
            background-color: var(--surface-color);
            font-size: 14px;
            position: sticky;
            left: 0;
            z-index: 5;
        }
		
		.date-col.today {
			font-weight:bold;
			color:#FFFF55;
		}
        
        .plant-header-cell {
            vertical-align: bottom;
            height: 120px;
            padding-bottom: 8px;
        }

        .rotated-text {
            display: inline-block;
            transform: rotate(-90deg);
            white-space: nowrap;
            width: 25px; /* Matches cell height */
            height: 25px; /* Matches cell width */
            text-align: left;
			
			----padding-left: 14px;
			
			font-weight: normal;
        }

        .water-btn {
            width: 100%;
            height: 100%;
            min-width: 40px;
            border: none;
            cursor: pointer;
            display: block;
        }

        .water-btn.state-0 { background-color: var(--bg-color); }
        .water-btn.state-1 { background-color: var(--watered-color); }
        .water-btn.state-2 { background-color: var(--fertilized-color); }
        .water-btn.session-changed { border:2px dashed rgb(255,255,255,0.6); }

    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div id="menu-icon">&#9776;</div>
            <nav id="menu">
                <a href="#" id="nav-plants">Kasvit</a>
                <a href="#" id="nav-calendar">Kalenteri</a>
            </nav>
        </header>

        <main>
            <div id="plants-page" class="page">
                <ul id="plant-list"></ul>
                <div id="add-plant-row">
                    <input type="text" id="new-plant-name" class="plant-name-input" placeholder="Uuden kasvin nimi...">
                </div>
                <button id="add-plant-btn">Lisää kasvi</button>
            </div>

            <div id="calendar-page" class="page">
                <div id="calendar-container">
                    <table id="calendar-table">
                        <thead id="calendar-head"></thead>
                        <tbody id="calendar-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DB Setup ---
        const DB_NAME = 'PlantWateringDB';
        const DB_VERSION = 1;
        const PLANTS_STORE = 'plants';
        const WATERING_STORE = 'wateringData';
		const MAX_STATE = 2; // 0 = not watered, 1 = watered, 2 = fertilizer
        let db;

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject("Error opening DB: " + e.target.errorCode);
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const dbInstance = e.target.result;
                    if (!dbInstance.objectStoreNames.contains(PLANTS_STORE)) {
                        const plantStore = dbInstance.createObjectStore(PLANTS_STORE, { keyPath: 'id', autoIncrement: true });
                        plantStore.createIndex('order', 'order', { unique: false });
                    }
                    if (!dbInstance.objectStoreNames.contains(WATERING_STORE)) {
                        dbInstance.createObjectStore(WATERING_STORE, { keyPath: 'date' });
                    }
                };
            });
        }
        
        // --- State ---
        let plants = [];
        let wateringData = {};
        let tapTimer = null;
        let lastTapTarget = null;

        // --- UI Elements ---
        const menuIcon = document.getElementById('menu-icon');
        const menu = document.getElementById('menu');
        const navPlants = document.getElementById('nav-plants');
        const navCalendar = document.getElementById('nav-calendar');
        const pages = {
            plants: document.getElementById('plants-page'),
            calendar: document.getElementById('calendar-page'),
        };
        const plantListEl = document.getElementById('plant-list');
        const newPlantNameInput = document.getElementById('new-plant-name');
        const addPlantBtn = document.getElementById('add-plant-btn');
        const calendarHead = document.getElementById('calendar-head');
        const calendarBody = document.getElementById('calendar-body');

        // --- Core Functions ---
        async function initializeApp() {
            await openDb();
            await loadData();
            
            // Ensure today's date exists
            const today = getFormattedDate(new Date());
            if (!wateringData[today]) {
                const newDayData = {};
                plants.forEach(p => newDayData[p.id] = 0);
                wateringData[today] = newDayData;
                await saveWateringData(today, newDayData);
            }

            setupEventListeners();
            
            if (plants.length > 0) {
                showPage('calendar');
            } else {
                showPage('plants');
            }
            renderAll();
        }

        async function loadData() {
            const plantTx = db.transaction(PLANTS_STORE, 'readonly');
            const plantStore = plantTx.objectStore(PLANTS_STORE);
            const plantIndex = plantStore.index('order');
            plants = await new Promise((resolve) => {
                const allPlants = [];
                plantIndex.openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        allPlants.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(allPlants);
                    }
                };
            });

            const waterTx = db.transaction(WATERING_STORE, 'readonly');
            const waterStore = waterTx.objectStore(WATERING_STORE);
            const waterRecords = await new Promise((resolve) => waterStore.getAll().onsuccess = (e) => resolve(e.target.result));
            
            wateringData = {};
            waterRecords.forEach(record => {
                wateringData[record.date] = record.data;
            });
        }

        function getFormattedDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = String(date.getFullYear()).slice(-2);
            return `${d}.${m}.${y}`;
        }
        
        function showPage(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');
            
            navPlants.classList.toggle('active', pageName === 'plants');
            navCalendar.classList.toggle('active', pageName === 'calendar');

            menu.classList.remove('open');
        }

        // --- Rendering ---
        function renderAll() {
            renderPlantsPage();
            renderCalendarPage();
        }

        function renderPlantsPage() {
            plantListEl.innerHTML = '';
            plants.forEach(plant => {
                const li = document.createElement('li');
                li.className = 'plant-row';
                li.dataset.id = plant.id;
                li.draggable = true;
                li.innerHTML = `
                    <span class="reorder-handle plant-btn">↕️</span>
                    <input type="text" class="plant-name-input" value="${plant.name}" data-id="${plant.id}">
                    <button class="delete-btn plant-btn" data-id="${plant.id}">🗑️</button>
                `;
                plantListEl.appendChild(li);
            });
        }
        
        function renderCalendarPage() {
            calendarHead.innerHTML = '';
            calendarBody.innerHTML = '';
            
            if (plants.length === 0) return;

            // Header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>&nbsp;</th>`;
            plants.forEach(plant => {
                const th = document.createElement('th');
                th.className = 'plant-header-cell';
                th.innerHTML = `<span class="rotated-text">&nbsp;${plant.name}</span>`;
                headerRow.appendChild(th);
            });
            calendarHead.appendChild(headerRow);
            
            // Body
            const sortedDates = Object.keys(wateringData).sort((a, b) => {
                const [da, ma, ya] = a.split('.').map(Number);
                const [db, mb, yb] = b.split('.').map(Number);
                return new Date(`20${yb}`, mb - 1, db) - new Date(`20${ya}`, ma - 1, da);
            });
			
			let todaycss = "today";

            sortedDates.forEach(date => {
                const row = document.createElement('tr');
				let dateformatted = date; //date.replaceAll('.', '-');
                row.innerHTML = `<td class="date-col ${todaycss}">${dateformatted}</td>`;
                const dayData = wateringData[date] || {};

                plants.forEach(plant => {
                    const td = document.createElement('td');
                    const state = dayData[plant.id] || 0;
                    td.innerHTML = `<button class="water-btn state-${state}" data-date="${date}" data-plant-id="${plant.id}"></button>`;
                    row.appendChild(td);
                });
                calendarBody.appendChild(row);
				
				todaycss = "";
            });
        }
        
        // --- Data Modification ---
        async function addPlant() {
            const name = newPlantNameInput.value.trim();
            if (!name) return;

            const maxOrder = plants.length > 0 ? Math.max(...plants.map(p => p.order)) : -1;
            const newPlant = { name: name, order: maxOrder + 1 };
            
            const tx = db.transaction(PLANTS_STORE, 'readwrite');
            const store = tx.objectStore(PLANTS_STORE);
            const request = store.add(newPlant);
            
            request.onsuccess = async (e) => {
                newPlant.id = e.target.result;
                plants.push(newPlant);
                newPlantNameInput.value = '';
                
                // Add new plant to all existing watering records
                const waterTx = db.transaction(WATERING_STORE, 'readwrite');
                const waterStore = waterTx.objectStore(WATERING_STORE);
                for (const date in wateringData) {
                    wateringData[date][newPlant.id] = 0;
                    waterStore.put({ date: date, data: wateringData[date] });
                }
                
                await waterTx.complete;
                renderAll();
            };
        }

        async function updatePlantName(id, newName) {
            const plant = plants.find(p => p.id === id);
            if (plant && plant.name !== newName) {
                plant.name = newName;
                const tx = db.transaction(PLANTS_STORE, 'readwrite');
                tx.objectStore(PLANTS_STORE).put(plant);
                await tx.complete;
                renderCalendarPage(); // Only need to re-render calendar header
            }
        }
        
        async function deletePlant(id) {
            if (!confirm('Are you sure you want to delete this plant and all its watering history?')) return;
            
            // Delete from plants store
            const plantTx = db.transaction(PLANTS_STORE, 'readwrite');
            plantTx.objectStore(PLANTS_STORE).delete(id);
            await plantTx.complete;

            plants = plants.filter(p => p.id !== id);
            
            // Delete plant's data from watering store
            const waterTx = db.transaction(WATERING_STORE, 'readwrite');
            const waterStore = waterTx.objectStore(WATERING_STORE);
            for (const date in wateringData) {
                delete wateringData[date][id];
                waterStore.put({ date: date, data: wateringData[date] });
            }
            await waterTx.complete;
            
            renderAll();
            if (plants.length === 0) {
                showPage('plants');
            }
        }

        async function saveWateringData(date, data) {
            const tx = db.transaction(WATERING_STORE, 'readwrite');
            tx.objectStore(WATERING_STORE).put({ date, data });
            return tx.complete;
        }

        async function updatePlantOrder() {
            const tx = db.transaction(PLANTS_STORE, 'readwrite');
            const store = tx.objectStore(PLANTS_STORE);
            plants.forEach((plant, index) => {
                plant.order = index;
                store.put(plant);
            });
            await tx.complete;
            renderAll();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            menuIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('open');
            });

            document.addEventListener('click', () => menu.classList.remove('open'));
            menu.addEventListener('click', (e) => e.stopPropagation());
            
            navPlants.addEventListener('click', (e) => { e.preventDefault(); showPage('plants'); });
            navCalendar.addEventListener('click', (e) => { e.preventDefault(); showPage('calendar'); });

            addPlantBtn.addEventListener('click', addPlant);
            newPlantNameInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') addPlant();
            });

            plantListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    deletePlant(id);
                }
            });

            plantListEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('plant-name-input')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const newName = e.target.value.trim();
                    updatePlantName(id, newName);
                }
            });

            // Double Tap Logic for Calendar
            calendarBody.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.classList.contains('water-btn')) return;

                if (tapTimer && lastTapTarget === target) {
                    // Double tap
                    clearTimeout(tapTimer);
                    tapTimer = null;
                    lastTapTarget = null;
                    
                    const date = target.dataset.date;
                    const plantId = parseInt(target.dataset.plantId, 10);
                    
                    const currentState = wateringData[date][plantId];
                    let newState = currentState+1;
					if(newState > MAX_STATE){
						newState = 0;
					}
                    wateringData[date][plantId] = newState;

                    target.classList.remove('state-0', 'state-1', 'state-2');
                    target.classList.add(`state-${newState}`, 'session-changed');
					console.log(wateringData);

                    saveWateringData(date, wateringData[date]);
                } else {
                    // First tap
                    if(tapTimer) clearTimeout(tapTimer);
                    lastTapTarget = target;
                    tapTimer = setTimeout(() => {
                        tapTimer = null;
                        lastTapTarget = null;
                    }, 300); // 300ms double tap window
                }
            });

            // Drag and Drop for Plant Reordering
            let draggedItem = null;
            plantListEl.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('plant-row')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            plantListEl.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;

                    // Update local 'plants' array order
                    const newOrderedIds = [...plantListEl.querySelectorAll('.plant-row')].map(row => parseInt(row.dataset.id));
                    plants.sort((a, b) => newOrderedIds.indexOf(a.id) - newOrderedIds.indexOf(b.id));

                    // Persist new order to DB
                    updatePlantOrder();
                }
            });
            
            plantListEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(plantListEl, e.clientY);
                if (afterElement == null) {
                    plantListEl.appendChild(draggedItem);
                } else {
                    plantListEl.insertBefore(draggedItem, afterElement);
                }
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.plant-row:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Start App ---
        initializeApp();
    });
    </script>
</body>
</html>