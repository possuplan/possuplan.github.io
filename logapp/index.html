<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
 
 	<!-- note: remove slashes from filenames, also from manifest, and change bgcolors to black -->
	<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
	<link rel="manifest" href="site.webmanifest">

	<!--this fucks up dblclick event from firing since its not allowed to zoom:-->
	
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<!--
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	-->
	
   
	
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<meta property="og:title" content="LogApp">
	<meta property="og:description" content="Log your events">
	
    <title>LogApp</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #f0f0f0;
            --primary-color: #0a84ff;
            --surface-color: #0a0d0a;
            --border-color: #8f8f8f;
            --watered-color: #022772; /* Dark Blue */
			--fertilized-color: #046817;
            --session-change-color: #3399ff; /* Light Blue */
            --danger-color: #ff3b30;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
        }
        
        /* --- START: Added Loader CSS --- */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-spinner {
            border: 8px solid var(--surface-color); 
            border-top: 8px solid var(--primary-color); 
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- END: Added Loader CSS --- */

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        #menu-icon {
            font-size: 28px;
            padding: 15px;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1002;
        }
        
        #menu {
            position: fixed;
            top: 0;
            left: -250px;
            width: 200px;
            height: 100%;
            background-color: var(--surface-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            transition: left 0.3s ease;
            z-index: 1001;
            padding-top: 60px;
        }

        #menu.open {
            left: 0;
        }

        #menu a {
            display: block;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-size: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        #menu a:hover {
            background-color: var(--primary-color);
        }
        #menu a.active {
            background-color: var(--primary-color);
        }

        main {
            padding: 60px 5px 15px 5px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .page { display: none; }
        .page.active { display: block; }
        
        /* --- Plants Page --- */
        #plant-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plant-row, #add-plant-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 5px;
            background-color: var(--surface-color);
            border-radius: 5px;
        }

        .plant-row.dragging {
            opacity: 0.5;
            background: var(--primary-color);
        }

        .plant-name-input {
            flex-grow: 1;
			min-width: 50px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }
		
        .plant-style-input {
            flex-grow: 1;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }
		
		.plant-group-input {
            flex-grow: 1;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
        }
		
        .plant-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
        }

        .reorder-handle { cursor: grab; }
        .reorder-handle:active { cursor: grabbing; }
        .delete-btn { color: var(--danger-color); }

        #add-plant-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        /* --- Calendar Page --- */
        #calendar-container {
            width: 100%;
            height: calc(100vh - 75px); /* Full viewport height minus top padding */
            overflow: auto; /* Enables both horizontal and vertical scrolling */
        }
        
        #calendar-table {
            border-collapse: collapse;
           
    border-spacing: 0px;
        }

        #calendar-table th {
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 0;

            height: 170px  !important;
			
			background-color: var(--surface-color);
            position: sticky;
            top: -1px;
            z-index: 10;
        }
		
		#calendar-table td {
            border: 1px solid var(--border-color);
            text-align: center;
            padding: 0;
			---width: 40px;
            height: 40px;
        }
		
	
		
	

        .plant-header-cell {
            vertical-align: bottom;
			width: 40px !important;
			min-width: 40px !important;
            padding-bottom: 8px;
        }
		
		.date-col-corner {
            min-width: 70px !important;
            max-width: 70px !important;
			height: 170px  !important;
		}
		
		.weekstart {
			border-bottom:3px solid rgb(204,204,204);
		}

        .date-col {
            min-width: 70px;
            max-width: 70px;
            background-color: var(--surface-color);
            font-size: 14px;
            position: sticky;
            left: -1px;
            z-index: 5;
        }
		

		
		.date-col.today {
			font-weight:bold;
			color:#FFFF55;
		}
        

        .rotated-text {
            display: inline-block;
            transform: rotate(-90deg);
            white-space: nowrap;
            width: 25px; /* Matches cell height */
            height: 25px; /* Matches cell width */
            text-align: left;
			
			
			font-weight: normal;
        }

        .water-btn {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            display: block;
		    background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px; /* Make the number readable */
			
			
		    user-select: none;
		    -webkit-user-select: none; /* Safari */
		    -ms-user-select: none;     /* Old IE/Edge */
		  
		    touch-action: manipulation; /* avoids double-tap zoom */
        }
		
	
		
		.focused-style-title {
			background-color:#222244 !important;
		}
		.focused-style-cell {
			border-right:2px solid white !important;
			border-left:2px solid white !important;
		}
		
		#calendar-head {
			
		    user-select: none;
		    -webkit-user-select: none; /* Safari */
		    -ms-user-select: none;     /* Old IE/Edge */
		  
		    touch-action: manipulation; /* avoids double-tap zoom */
		}

    
        .water-btn.session-changed { border:1px dashed rgb(153,153,153); }



/* Top tabs container */
#top-tabs-container {
    overflow-x: auto; /* allow horizontal scroll */
    white-space: nowrap; /* keep tabs in one line */
    flex-grow: 1; /* fill remaining space next to menu-icon */
	position:relative;
	//left:60px;
	//top:10px;
	margin-left:60px;
	margin-top:10px;
	    -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
    scrollbar-width: none; /* Firefox */
}



#top-tabs-container::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}


#top-tabs {
    display: inline-flex;
}

.tab {
    display: inline-block;
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
}

.tab.active {
    border-bottom: 2px solid blue;
    font-weight: bold;
}

    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="loader-spinner"></div>
    </div>
    <div id="app-container" style="visibility: hidden;">
		<header>
            <div id="menu-icon">&#9776;</div>
			
			<div id="top-tabs-container">
				<div id="top-tabs"></div>
			</div>
		
            <nav id="menu">
                <a href="#" id="nav-plants">Teot</a>
                <a href="#" id="nav-calendar">Kalenteri</a>
            </nav>
        </header>

        <main>
            <div id="plants-page" class="page">
                <ul id="plant-list"></ul>
                <div id="add-plant-row">
                    <input type="text" class="plant-name-input" id="new-plant-name" placeholder="Uuden teon nimi...">
					<select class="plant-style-input" id="default-plant-style-input"></select>
					<select class="plant-group-input" id="default-plant-group-input"></select>
                </div>
                <button id="add-plant-btn">Lis√§√§ teko</button>
            </div>

            <div id="calendar-page" class="page">
                <div id="calendar-container">
                    <table id="calendar-table">
                        <thead id="calendar-head"></thead>
                        <tbody id="calendar-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DB Setup database ---
        const DB_NAME = 'UserActionsDB';
        const DB_VERSION = 2;
        const PLANTS_STORE = 'actions';
        const WATERING_STORE = 'actionsData';
		const SETTINGS_STORE = 'settings';
        let db;
		
		
		const SETTING_LAST_OPEN_TAB = "lastOpenTab";
		let currentGroupOpen = -1;
		
		const deleteall = false;
		if(deleteall){
			const request = indexedDB.deleteDatabase(DB_NAME);
			
			request.onsuccess = function () {
			  console.log(`Database "${DB_NAME}" deleted successfully`);
			};

			request.onerror = function () {
			  console.error(`Error deleting database "${DB_NAME}"`);
			};

			request.onblocked = function () {
			  console.warn(`Delete blocked: Please close all tabs using "${DB_NAME}"`);
			};
	
		}
		
		

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject("Error opening DB: " + e.target.errorCode);
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const dbInstance = e.target.result;
                    if (!dbInstance.objectStoreNames.contains(PLANTS_STORE)) {
                        const plantStore = dbInstance.createObjectStore(PLANTS_STORE, { keyPath: 'id', autoIncrement: true });
                        plantStore.createIndex('order', 'order', { unique: false });
                    }
                    if (!dbInstance.objectStoreNames.contains(WATERING_STORE)) {
                        dbInstance.createObjectStore(WATERING_STORE, { keyPath: 'date' });
                    }
					// New store for settings
					if (!dbInstance.objectStoreNames.contains(SETTINGS_STORE)) {
						dbInstance.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
					}
                };
            });
        }
		function getSetting(key) {
			return new Promise((resolve, reject) => {
				const transaction = db.transaction([SETTINGS_STORE], 'readonly');
				const store = transaction.objectStore(SETTINGS_STORE);
				const request = store.get(key);

				request.onsuccess = () => resolve(request.result?.value);
				request.onerror = () => reject(request.error);
			});
		}

		function saveSetting(key, value) {
			const transaction = db.transaction([SETTINGS_STORE], 'readwrite');
			const store = transaction.objectStore(SETTINGS_STORE);
			store.put({ key, value });
		}
		
	
		
		
		let plantStyles = [
			{id:0, text:"Numero", type:0},
			{id:10, text:"‚úî", type:1},
			{id:20, text:"‚úñ", type:1},
			{id:21, text:"‚òÖ", type:1},
			{id:22, text:"‚úø", type:1},
			{id:23, text:"‚óè", type:1},
			{id:24, text:"‚ñ†", type:1},
			{id:25, text:"üçÑ", type:1},
			{id:26, text:"‚õ∫", type:1},
			{id:30, text:"1 v√§ri", colors: ["", "#022772"], type:2},
			{id:40, text:"2 v√§ri√§", colors: ["", "#022772", "#046817"], type:2},
			{id:50, text:"Emoji", list: ["", "üòê", "üòä", "üòÅ", "üòÇ", "üòç", "üôÅ", "üò≠", "üò°"], type:3},
		];
		
		let plantGroups = [
			{id: -1, text: "Ryhm√§", order: 0, notSelectable: true},
			{id: 0, text: "Muut", order: 1},
			{id: 1, text: "Kasvit", order: 2},
			{id: 2, text: "Siivous", order: 3},
			{id: 3, text: "Makuuhuone", order: 4},
			{id: 4, text: "Olohuone", order: 5},
			{id: 5, text: "Parveke", order: 6},
		];

		// plantStyles.find(s => s.id == style)?.type ?? 0;
		function findType(style){
			for(let i = 0; i < plantStyles.length; i++){
				if(plantStyles[i].id == style){
					return plantStyles[i].type;
				}
			}
			return 0;
		}
		
		// plantStyles.find(s => s.id == style)?.text ?? "";
		function findText(style){
			for(let i = 0; i < plantStyles.length; i++){
				if(plantStyles[i].id == style){
					return plantStyles[i].text;
				}
			}
			return "";
		}
		
		// plantStyles.find(s => s.id == style)?.colors ?? null;
		function findColors(style){
			for(let i = 0; i < plantStyles.length; i++){
				if(plantStyles[i].id == style){
					return plantStyles[i].colors;
				}
			}
			return null;
		}
		
		// plantStyles.find(s => s.id == style)?.colors ?? null;
		function findList(style){
			for(let i = 0; i < plantStyles.length; i++){
				if(plantStyles[i].id == style){
					return plantStyles[i].list;
				}
			}
			return null;
		}
	
        // --- State ---
        let plants = [];
        let wateringData = {};
        let tapTimer = null;
        let lastTapTarget = null;
		
		let lastClickedTh = null;
		let lastClickedTitleID = null;
		let focusedTitleBG = "#242541";

        // --- UI Elements ---
        const loaderOverlay = document.getElementById('loader-overlay'); // <-- START: Added loader element
        const appContainer = document.getElementById('app-container'); // <-- START: Added app container
        const menuIcon = document.getElementById('menu-icon');
        const menu = document.getElementById('menu');
        const navPlants = document.getElementById('nav-plants');
        const navCalendar = document.getElementById('nav-calendar');
        const pages = {
            plants: document.getElementById('plants-page'),
            calendar: document.getElementById('calendar-page'),
        };
        const plantListEl = document.getElementById('plant-list');
        const newPlantNameInput = document.getElementById('new-plant-name');
		const newPlantStyleSelect = document.getElementById('default-plant-style-input');
		const newPlantGroupSelect = document.getElementById('default-plant-group-input');
		const topTabs = document.getElementById('top-tabs');
        const addPlantBtn = document.getElementById('add-plant-btn');
        const calendarHead = document.getElementById('calendar-head');
        const calendarBody = document.getElementById('calendar-body');




		// Generate options dynamically
		let plantStylesOptionsHTML = plantStyles.map(style => {
			return `<option value="${style.id}">${style.text}</option>`;
		}).join('');
		newPlantStyleSelect.innerHTML = plantStylesOptionsHTML;
		
		let plantGroupsOptionsHTML = plantGroups.map(group => {
			return `<option value="${group.id}" ${group.notSelectable ? " disabled selected" : ""}>${group.text}</option>`;
		}).join('');
		newPlantGroupSelect.innerHTML = plantGroupsOptionsHTML;
		

		
		function renderTopTabs() {
			// ${group.order === 0 ? "active" : ""}
			let topTabShowAll = `<div class="tab active" data-id="-1">*</div>`;
			let topTabsHTML = topTabShowAll+plantGroups
				.filter(group => group.id !== -1)
				.map(group => {
				return `<div class="tab" data-id="${group.id}">${group.text}</div>`;
			}).join('');
			topTabs.innerHTML = topTabsHTML;
		}
		
		function activateLastTab() {
			console.log("activateLastTab");
			getSetting(SETTING_LAST_OPEN_TAB).then(lastTabId => {
				const tabs = document.querySelectorAll('.tab');
				let tabToActivate;

				if (lastTabId) {
					currentGroupOpen = lastTabId;
					console.log("current group open: "+lastTabId);
					tabs.forEach(tab => tab.classList.remove('active'));
					tabToActivate = Array.from(tabs).find(tab => tab.dataset.id === lastTabId);
				} else {
					// fallback: first tab active
					tabToActivate = tabs[0];
					const defaultTabId = tabToActivate.dataset.id; 
					currentGroupOpen = defaultTabId;
					console.log("current group open: "+defaultTabId);
					// save the default tab into the DB so future calls succeed
					saveSetting(SETTING_LAST_OPEN_TAB, defaultTabId);
				}

				if (tabToActivate) {
					tabToActivate.classList.add('active');
					// scroll the tab into view
					tabToActivate.scrollIntoView({ behavior: 'smooth', inline: 'center' });
				}
			});
		}
		
		renderTopTabs();
		
		/*            <div id="top-tabs">
			<!--
                <div class="tab active">Tab 1</div>
                <div class="tab">Tab 2</div>
                <div class="tab">Tab 3</div>
                <div class="tab">Tab 4</div>
                <div class="tab">Tab 5</div>
                <div class="tab">Tab 6</div>
				-->
            </div>*/

		function getDisplayValue(state, style){
			let type = findType(style);//plantStyles.find(s => s.id == style)?.type ?? 0;
			let icon = findText(style);//plantStyles.find(s => s.id == style)?.text ?? "";
			
			
			let displayText = "";
			let bgcolor = "";
			
			switch(type){
				case 1: // icon on/off
					displayText = state > 0 ? icon : '';
				break;
				case 2: // bgcolor looping
					// no text.
					let colors = findColors(style);//plantStyles.find(s => s.id == style)?.colors ?? null;
					if(colors){
						if(state < colors.length){
							bgcolor = colors[state];
						}else{
							bgcolor = colors[colors.length-1];
						}
					}
				break;
				case 3: // emoji looping
					let list = findList(style);//plantStyles.find(s => s.id == style)?.list ?? null;
					if(list){
						if(state < list.length){
							displayText = list[state];
						}else{
							displayText = list[list.length-1];
						}
					}
				break;
				default: // type 0
					displayText = state > 0 ? state : '';
				break;
			}
			return {text: displayText, bgcolor: bgcolor};
		}

		
        // --- Core Functions ---
		async function initializeApp() {
			await openDb();
			await loadData();
			await loadLastTab();


			const today = new Date();
			const pastdate = new Date();
			pastdate.setDate(today.getDate() - 14);
			
			
			const pastdateStr = getFormattedDate(pastdate);
			//console.log(pastdateStr);

			// Determine first date to start filling from
			let earliestDate = pastdate;
			const keys = Object.keys(wateringData);

			if (keys.length > 0) {
				const parsedDates = keys.map(k => {
					const [d, m, y] = k.split('.');
					return new Date(`20${y}`, m - 1, d);
				});
				earliestDate = new Date(Math.min(...parsedDates));
			}

			// Fill all days from earliestDate to today
			const allDates = getDateRange(earliestDate, today);
			for (const date of allDates) {
				const dateStr = getFormattedDate(date);
				
				if (!wateringData[dateStr]) {
					const newDayData = {};
					plants.forEach(p => newDayData[p.id] = 0);
					wateringData[dateStr] = newDayData;
					console.log(dateStr);
					await saveWateringData(dateStr, newDayData);
				}
			}

			setupEventListeners();

			if (plants.length > 0) {
				showPage('calendar');
			} else {
				showPage('plants');
			}
			renderAll();
            
            // --- START: Added logic to hide loader ---
            // Make the main content visible now that it's ready
            appContainer.style.visibility = 'visible';
            
            // Fade out and then hide the loader
            loaderOverlay.style.opacity = '0';
            loaderOverlay.addEventListener('transitionend', () => {
                loaderOverlay.style.display = 'none';
            }, { once: true }); // 'once' ensures the event listener is removed after firing
            // --- END: Added logic to hide loader ---
		}


		async function loadLastTab() {
			//currentGroupOpen = await getSetting(SETTING_LAST_OPEN_TAB);
			
			
			await getSetting(SETTING_LAST_OPEN_TAB).then(lastTabId => {
				const tabs = document.querySelectorAll('.tab');
				let tabToActivate;

				if (lastTabId) {
					currentGroupOpen = lastTabId;
					console.log("current group open: "+lastTabId);
					tabs.forEach(tab => tab.classList.remove('active'));
					tabToActivate = Array.from(tabs).find(tab => tab.dataset.id === lastTabId);
				} else {
					// fallback: first tab active
					tabToActivate = tabs[0];
					const defaultTabId = tabToActivate.dataset.id; 
					currentGroupOpen = defaultTabId;
					console.log("current group open: "+defaultTabId);
					// save the default tab into the DB so future calls succeed
					saveSetting(SETTING_LAST_OPEN_TAB, defaultTabId);
				}

				if (tabToActivate) {
					tabToActivate.classList.add('active');
					// scroll the tab into view
					tabToActivate.scrollIntoView({ behavior: 'smooth', inline: 'center' });
				}
			});
		}
		
		
        async function loadData() {
            const plantTx = db.transaction(PLANTS_STORE, 'readonly');
            const plantStore = plantTx.objectStore(PLANTS_STORE);
            const plantIndex = plantStore.index('order');
            plants = await new Promise((resolve) => {
                const allPlants = [];
                plantIndex.openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        allPlants.push(cursor.value);
                        cursor.continue();
                    } else {
                        resolve(allPlants);
						console.log(allPlants);
                    }
                };
            });

            const waterTx = db.transaction(WATERING_STORE, 'readonly');
            const waterStore = waterTx.objectStore(WATERING_STORE);
            const waterRecords = await new Promise((resolve) => waterStore.getAll().onsuccess = (e) => resolve(e.target.result));
            
            wateringData = {};
            waterRecords.forEach(record => {
                wateringData[record.date] = record.data;
            });
        }

        function getFormattedDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = String(date.getFullYear()).slice(-2);
            return `${d}.${m}.${y}`;
        }
		
		
		function getDateRange(start, end) {
			const dates = [];
			let current = new Date(start);
			while (current <= end) {
				dates.push(new Date(current));
				current.setDate(current.getDate() + 1);
			}
			return dates;
		}
		
		
		function getWeekday(dateStr) {
		  // dateStr in format "dd.mm.yy"
		  const [dd, mm, yy] = dateStr.split(".");
		  
		  // Fix year, e.g. "25" -> 2025
		  const year = 2000 + parseInt(yy, 10);  
		  const month = parseInt(mm, 10) - 1; // JS month is 0-indexed
		  const day = parseInt(dd, 10);

		  const date = new Date(year, month, day);

		  const weekdays = ["Su", "Ma", "Ti", "Ke", "To", "Pe", "La"];
		  return weekdays[date.getDay()];
		}
        
		
        function showPage(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');
            
            navPlants.classList.toggle('active', pageName === 'plants');
            navCalendar.classList.toggle('active', pageName === 'calendar');

            menu.classList.remove('open');
        }

        // --- Rendering ---
        function renderAll() {
            renderPlantsPage();
            renderCalendarPage();
        }
		

        function renderPlantsPage() {
            plantListEl.innerHTML = '';
            plants.forEach(plant => {
                const li = document.createElement('li');
                li.className = 'plant-row';
                li.dataset.id = plant.id;
                li.draggable = true;
				
				// Generate options dynamically
				let optionsHTML = plantStyles.map(style => {
					return `<option value="${style.id}" ${style.id == plant.style ? 'selected' : ''}>${style.text}</option>`;
				}).join('');
						
				let groupsOptionsHTML = plantGroups.map(group => {
					return `<option value="${group.id}" ${group.notSelectable ? " disabled" : ""} ${group.id == plant.group ? 'selected' : ''}>${group.text}</option>`;
				}).join('');
				

                li.innerHTML = `
                    <span class="reorder-handle plant-btn">‚ÜïÔ∏è</span>
                    <input type="text" class="plant-name-input" value="${plant.name}" data-id="${plant.id}">
					<select class="plant-style-input" data-id="${plant.id}">
						${optionsHTML}
					</select>
					<select class="plant-group-input" data-id="${plant.id}">
						${groupsOptionsHTML}
					</select>
                    <button class="delete-btn plant-btn" data-id="${plant.id}">üóëÔ∏è</button>
                `;
                plantListEl.appendChild(li);
            });
        }
		
		function showCompactView(){
			renderCalendarPage(true);
		}
		function showNormalView(){
			renderCalendarPage();
		}
        
        function renderCalendarPage(compactView) {
            calendarHead.innerHTML = '';
            calendarBody.innerHTML = '';
            
            if (plants.length === 0) return;

            // Header
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th class="date-col-corner">&nbsp;</th>`;
            plants.forEach(plant => {
                const th = document.createElement('th');
                th.className = 'plant-header-cell';
				th.dataset.id = plant.id;
				if(lastClickedTh && lastClickedTh.dataset.id === th.dataset.id){
					th.classList.add("focused-style-title");
				}
				let group = plant.group;
				let displayColumn = false;
				if(currentGroupOpen == -1){
					displayColumn = true;
				}else{
					if(currentGroupOpen == group){
						displayColumn = true;
					}
				}
				if(displayColumn){
					th.innerHTML = `<span class="rotated-text">&nbsp;${plant.name}</span>`;
					headerRow.appendChild(th);
				}
            });
            calendarHead.appendChild(headerRow);
            
            // Body
            const sortedDates = Object.keys(wateringData).sort((a, b) => {
                const [da, ma, ya] = a.split('.').map(Number);
                const [db, mb, yb] = b.split('.').map(Number);
                return new Date(`20${yb}`, mb - 1, db) - new Date(`20${ya}`, ma - 1, da);
            });
			
			

            sortedDates.forEach((date, index) => {
				let todaycss = (index === 0) ? "today" : ""; // highlight first item.
				let dateformatted = date;
				let dayshortname = getWeekday(date);
				
                const row = document.createElement('tr');
				if(dayshortname == "Ma"){ // "Ma" is from predefined array for finnish daynames.
					row.classList.add("weekstart");
				}
				
                row.innerHTML = `<td class="date-col ${todaycss}">${dayshortname}<br>${dateformatted}</td>`;
                const dayData = wateringData[date] || {};
				
				let addRow = true;
				if(compactView){
					let foundItems = 0;
					plants.forEach(plant => {
						const td = document.createElement('td');
						const state = dayData[plant.id] || 0;
						
						if(lastClickedTh && lastClickedTh.dataset.id == plant.id){
							if(state){
								foundItems++;
							}
						}
					});
					if(!foundItems){
						addRow = false;
					}
				}
				
				if(addRow){
					plants.forEach(plant => {
						const td = document.createElement('td');
						const state = dayData[plant.id] || 0;
						const style = plant.style || 0;
						const type = findType(style);//plantStyles.find(s => s.id == style)?.type ?? 0;
						const group = plant.group;
						
						let displayColumn = false;
						if(currentGroupOpen == -1){
							displayColumn = true;
						}else{
							if(currentGroupOpen == group){
								displayColumn = true;
							}
						}
						
						
						if(displayColumn){

							let focusedStr = "";
							if(lastClickedTh && lastClickedTh.dataset.id == plant.id){
								//td.classList.add("focused-color");
								focusedStr = " focused-style-cell";
							}

	// calendarBody.addEventListener('dblclick',

							let { text: displayText, bgcolor: background } = getDisplayValue(state, style);
							
							let cssStyle = "";
							if(background){
								cssStyle = "background-color: "+background;
							}
				
							td.innerHTML = `<button class="water-btn ${focusedStr}" data-date="${date}" data-plant-id="${plant.id}" data-style="${style}" style="${cssStyle}">${displayText}</button>`;
							row.appendChild(td);
						}
					
					});	
					calendarBody.appendChild(row);
				}

            });
        }
        
        // --- Data Modification ---
        async function addPlant() {
            const name = newPlantNameInput.value.trim();
			const style = newPlantStyleSelect.value.trim();
			const group = newPlantGroupSelect.value.trim();
            if (!name) return;

            const maxOrder = plants.length > 0 ? Math.max(...plants.map(p => p.order)) : -1;
            const newPlant = { name: name, order: maxOrder+1, style: style, group: group};
            
            const tx = db.transaction(PLANTS_STORE, 'readwrite');
            const store = tx.objectStore(PLANTS_STORE);
            const request = store.add(newPlant);
            
            request.onsuccess = async (e) => {
                newPlant.id = e.target.result;
                plants.push(newPlant);
                newPlantNameInput.value = '';
                
                // Add new plant to all existing watering records
                const waterTx = db.transaction(WATERING_STORE, 'readwrite');
                const waterStore = waterTx.objectStore(WATERING_STORE);
                for (const date in wateringData) {
                    wateringData[date][newPlant.id] = 0;
                    waterStore.put({ date: date, data: wateringData[date] });
                }
                
                await waterTx.complete;
                renderAll();
            };
        }
		
		
		
        async function updatePlantStyle(id, newStyle) {
            const plant = plants.find(p => p.id === id);
            if (plant && plant.style !== newStyle) {
                plant.style = newStyle;
                const tx = db.transaction(PLANTS_STORE, 'readwrite');
                tx.objectStore(PLANTS_STORE).put(plant);
                await tx.complete;
                renderCalendarPage(); // Only need to re-render calendar header
            }
        }
		
		async function updatePlantGroup(id, newGroup) {
            const plant = plants.find(p => p.id === id);
            if (plant && plant.group !== newGroup) {
                plant.group = newGroup;
                const tx = db.transaction(PLANTS_STORE, 'readwrite');
                tx.objectStore(PLANTS_STORE).put(plant);
                await tx.complete;
                renderCalendarPage(); // Only need to re-render calendar header
            }
        }
		
		
        async function updatePlantName(id, newName) {
            const plant = plants.find(p => p.id === id);
            if (plant && plant.name !== newName) {
                plant.name = newName;
                const tx = db.transaction(PLANTS_STORE, 'readwrite');
                tx.objectStore(PLANTS_STORE).put(plant);
                await tx.complete;
                renderCalendarPage(); // Only need to re-render calendar header
            }
        }
        
        async function deletePlant(id) {
            if (!confirm('Are you sure you want to delete this plant and all its watering history?')) return;
            
            // Delete from plants store
            const plantTx = db.transaction(PLANTS_STORE, 'readwrite');
            plantTx.objectStore(PLANTS_STORE).delete(id);
            await plantTx.complete;

            plants = plants.filter(p => p.id !== id);
            
            // Delete plant's data from watering store
            const waterTx = db.transaction(WATERING_STORE, 'readwrite');
            const waterStore = waterTx.objectStore(WATERING_STORE);
            for (const date in wateringData) {
                delete wateringData[date][id];
                waterStore.put({ date: date, data: wateringData[date] });
            }
            await waterTx.complete;
            
            renderAll();
            if (plants.length === 0) {
                showPage('plants');
            }
        }

        async function saveWateringData(date, data) {
            const tx = db.transaction(WATERING_STORE, 'readwrite');
            tx.objectStore(WATERING_STORE).put({ date, data });
            return tx.complete;
        }

        async function updatePlantOrder() {
            const tx = db.transaction(PLANTS_STORE, 'readwrite');
            const store = tx.objectStore(PLANTS_STORE);
            plants.forEach((plant, index) => {
                plant.order = index;
                store.put(plant);
            });
            await tx.complete;
            renderAll();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            menuIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('open');
            });
			
			const tabsClasses = document.querySelectorAll('.tab');
			tabsClasses.forEach(tab => {
				tab.addEventListener('click', () => {
					tabsClasses.forEach(t => t.classList.remove('active'));
					tab.classList.add('active');
					// optional: scroll the tab into view
					tab.scrollIntoView({ behavior: 'smooth', inline: 'center' });
				});
			});
			
			const tabs = () => document.querySelectorAll('.tab');
			const tabsContainer = document.getElementById('top-tabs');
			tabsContainer.addEventListener('click', (e) => {
				const clickedTab = e.target.closest('.tab');
				if (!clickedTab) return; // clicked outside of a tab

				// Remove active class from all tabs
				tabs().forEach(tab => tab.classList.remove('active'));

				// Add active class to clicked tab
				clickedTab.classList.add('active');

				// Save clicked tab ID to DB
				const tabId = clickedTab.dataset.id;
				saveSetting(SETTING_LAST_OPEN_TAB, tabId);
				
				console.log("current group open: "+tabId);
				currentGroupOpen = tabId;

				// Optionally scroll it into view
				clickedTab.scrollIntoView({ behavior: 'smooth', inline: 'center' });
				
				renderCalendarPage();
			});
			
            document.addEventListener('click', () => menu.classList.remove('open'));
            menu.addEventListener('click', (e) => e.stopPropagation());
            
            navPlants.addEventListener('click', (e) => { e.preventDefault(); showPage('plants'); });
            navCalendar.addEventListener('click', (e) => { e.preventDefault(); showPage('calendar'); });

            addPlantBtn.addEventListener('click', addPlant);
            newPlantNameInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') addPlant();
            });

            plantListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    deletePlant(id);
                }
            });

            plantListEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('plant-name-input')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const newName = e.target.value.trim();
                    updatePlantName(id, newName);
                }
            });
			
            plantListEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('plant-style-input')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const newStyle = e.target.value.trim();
                    updatePlantStyle(id, newStyle);
                }
            });
			
			
            plantListEl.addEventListener('change', (e) => {
                if (e.target.classList.contains('plant-group-input')) {
                    const id = parseInt(e.target.dataset.id, 10);
                    const newGroup = e.target.value.trim();
                    updatePlantGroup(id, newGroup);
                }
            });

/*
            // Double Tap Logic for Calendar
            calendarBody.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.classList.contains('water-btn')) return;
				
				
				console.log("tap start");
			

                if (tapTimer && lastTapTarget === target) {
                    // Double tap
                    clearTimeout(tapTimer);
                    tapTimer = null;
                    lastTapTarget = null;
					
					console.log("+1");
						
					const date = target.dataset.date;
					const plantId = parseInt(target.dataset.plantId, 10);

					let currentState = wateringData[date][plantId] || 0;
					let newState = currentState + 1;
					wateringData[date][plantId] = newState;

					target.textContent = newState; // Update display
					target.classList.add('session-changed');

                    saveWateringData(date, wateringData[date]);
                } else {
                    // First tap
                    if(tapTimer) clearTimeout(tapTimer);
                    lastTapTarget = target;
					console.log("no tap timer - tap timer start");
                    tapTimer = setTimeout(() => {
                        tapTimer = null;
                        lastTapTarget = null;
						console.log("no tap timer - taptimer off");
                    }, 300); // 300ms double tap window
                }
            });
*/


            // --- START: New Calendar Event Logic ---
            let longPressTimer = null;
            const LONG_PRESS_DURATION = 500;

			
			calendarHead.addEventListener('dblclick', (e) => {
				e.preventDefault();

				// find the closest th with the right class and data-id
				const th = e.target.closest('th.plant-header-cell');

				if (!th) return; // clicked outside th

				let resetted = false;

				// reset previous clicked th (if any)
				if (lastClickedTh) {
					// reset to original bg color
					lastClickedTh.style.backgroundColor = "";
					
					// reset view if deselected title:
					if(lastClickedTh.dataset.id === th.dataset.id){
						lastClickedTh = null;
						lastClickedTitleID = null;
						resetted = true;
					}
				}
				
				if(!resetted){
					lastClickedTitleID = th.dataset.id;

					// update tracker
					lastClickedTh = th;

					console.log("clicked " + lastClickedTitleID);

					// change background color of that th
					th.style.backgroundColor = focusedTitleBG;
					showCompactView();

				}else{
				
					console.log("resetted ");
					showNormalView();
				}
				
				
			});
	
            // --- Double Tap to Increment ---
            calendarBody.addEventListener('dblclick', (e) => {
				console.log("fired");
                const target = e.target;
				//const target = e.target.closest('.water-btn');
				//if (!target) return;
                if (!target.classList.contains('water-btn')) return;
                
                e.preventDefault();

                const date = target.dataset.date;
                const plantId = parseInt(target.dataset.plantId, 10);
				const style = parseInt(target.dataset.style, 10);
				let type = findType(style);//plantStyles.find(s => s.id == style)?.type ?? 0;
				

                let currentState = wateringData[date][plantId] || 0;
	

	
                let newState = currentState + 1;
				switch(type){
					case 1:
						// on/off:
						if(newState > 1){
							newState = 0;
						}
					break;
					case 2:
						// array of colors:
						let colors = findColors(style);//plantStyles.find(s => s.id == style)?.colors ?? null;
						if(colors){
							if(newState > colors.length-1){
								newState = 0;
							}
						}
					break;
					case 3:
						// array of emoji:
						let list = findList(style);//plantStyles.find(s => s.id == style)?.list ?? null;
						if(list){
							if(newState > list.length-1){
								newState = 0;
							}
						}
					break;
					default: // type 0, numbered
						// no limits.
					break;
				}
				let { text: displayText, bgcolor: background } = getDisplayValue(newState, style);

// td.innerHTML = `<button class="water-btn ${focusedStr}" data-date="${date}" data-plant-id="${plant.id}" data-style="${style}">${displayText}</button>`;

                wateringData[date][plantId] = newState;

                target.textContent = displayText; // Update display
				if(background){
					target.style.backgroundColor = background;
				}else{
					target.style.backgroundColor = "";
				}
				
                target.classList.add('session-changed');

                saveWateringData(date, wateringData[date]);
            });


			function vibratePhone() {
			  if ("vibrate" in navigator) {
				// Vibrate for 200ms
				navigator.vibrate(200);

				// Or use a pattern: vibrate-pause-vibrate
				// navigator.vibrate([200, 100, 200]);
			  } else {
				console.log("Vibration API not supported on this device.");
			  }
			}
			
			
            // --- Long Press to Decrement ---
            const handleLongPress = (target) => {
                if (!target.classList.contains('water-btn')) return;

                const date = target.dataset.date;
                const plantId = parseInt(target.dataset.plantId, 10);
				const style = parseInt(target.dataset.style, 10);

                
                let currentState = wateringData[date][plantId] || 0;
                if (currentState > 0) {
                    let newState = currentState - 1;
					
		
					let { text: displayText, bgcolor: background } = getDisplayValue(newState, style);
					
					
                    wateringData[date][plantId] = newState;

                    target.textContent = displayText; // Update display
					if(background){
						target.style.backgroundColor = background;
					}else{
						target.style.backgroundColor = "";
					}
                    target.classList.add('session-changed');

                    saveWateringData(date, wateringData[date]);
					
					vibratePhone();
                }
            };

            const startPress = (e) => {
                if (e.type === 'mousedown' && e.button !== 0) return; // Only for left mouse button

                const target = e.target;
                if (!target.classList.contains('water-btn')) return;

                longPressTimer = setTimeout(() => {
                    handleLongPress(target);
                    longPressTimer = null; // Reset timer
                }, LONG_PRESS_DURATION);
            };

            const cancelPress = () => {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            };
			
			
            
            // Mouse events
            calendarBody.addEventListener('mousedown', startPress);
            calendarBody.addEventListener('mouseup', cancelPress);
            calendarBody.addEventListener('mouseleave', cancelPress, true);


            // Touch events
            calendarBody.addEventListener('touchstart', (e) => {
                // Prevent scrolling or other default actions while holding the button
                //if (e.target.classList.contains('water-btn')) {
                    //e.preventDefault();
                //}
                startPress(e);
            });
            calendarBody.addEventListener('touchend', cancelPress);
            calendarBody.addEventListener('touchcancel', cancelPress);
            
            // Prevent context menu on long press
            calendarBody.addEventListener('contextmenu', (e) => {
                if (e.target.classList.contains('water-btn')) {
                    e.preventDefault();
                }
            });
            // --- END: New Calendar Event Logic ---
			


            // Drag and Drop for Plant Reordering
            let draggedItem = null;
            plantListEl.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('plant-row')) {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            plantListEl.addEventListener('dragend', (e) => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;

                    // Update local 'plants' array order
                    const newOrderedIds = [...plantListEl.querySelectorAll('.plant-row')].map(row => parseInt(row.dataset.id));
                    plants.sort((a, b) => newOrderedIds.indexOf(a.id) - newOrderedIds.indexOf(b.id));

                    // Persist new order to DB
                    updatePlantOrder();
                }
            });
            
            plantListEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(plantListEl, e.clientY);
                if (afterElement == null) {
                    plantListEl.appendChild(draggedItem);
                } else {
                    plantListEl.insertBefore(draggedItem, afterElement);
                }
            });
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.plant-row:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- Start App ---
        initializeApp();
    });
    </script>
</body>
</html>