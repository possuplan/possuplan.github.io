<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PossuPlan - Rahankäytön Seuranta</title>
    <style>
        /* --- Global Styles & Dark Mode --- */
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #4CAF50; /* Green for highlights */
            --secondary-color: #2a2a2a;
            --tertiary-color: #333333;
            --input-bg: #2c2c2c;
            --border-color: #444444;
            --hover-color: #57a05a;
            --disabled-color: #757575;
            --danger-color: #dc3545;
            --danger-hover-color: #c82333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-size: 16px; /* Base font size */
        }

        h1, h2, h3 {
            color: var(--primary-color);
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        button:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        input[type="text"],
        input[type="number"],
        select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 10px;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.95em; /* Slightly smaller for compactness */
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }


        ul {
            list-style: none;
            padding: 0;
        }

        /* --- App Header & Navigation --- */
        .app-header {
            background-color: var(--secondary-color);
            padding: 0 10px; /* Reduced padding */
            height: 55px;
            display: flex;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .app-logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .nav-toggle {
            font-size: 1.8em;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px 8px; /* Reduced padding */
            margin-right: 10px; /* Space between toggle and logo/name */
            flex-shrink: 0;
        }

        .app-name-container {
            display: flex;
            align-items: center;
            justify-content: center; /* Center PossuPlan relative to its available space */
            flex-grow: 1;
            overflow: hidden; /* Prevent app name from pushing things around */
             margin-right: 40px; /* Space for nav-toggle approx width */
        }

        .app-name {
            font-size: 1.4em; /* Slightly reduced */
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            white-space: nowrap;
        }


        .nav-bar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 230px;
            height: 100vh;
            background-color: var(--secondary-color);
            padding-top: 60px;
            transition: left 0.3s ease-in-out;
            z-index: 999;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }

        .nav-bar.open {
            left: 0;
        }

        .nav-bar ul li a {
            display: block;
            padding: 15px 20px;
            color: var(--text-color);
            text-decoration: none;
            border-bottom: 1px solid var(--tertiary-color);
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .nav-bar ul li a:hover, .nav-bar ul li a.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* --- Main Content Area --- */
        .main-content {
            padding-top: 70px;
            padding-left: 15px; /* Reduced padding */
            padding-right: 15px; /* Reduced padding */
            padding-bottom: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Purchases Page --- */
        .purchases-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px; /* Reduced margin */
            flex-wrap: wrap;
        }
         .purchases-header h2 {
            margin-right: 10px;
            font-size: 1.3em;
        }


        #current-date-btn {
            font-size: 1em; /* Reduced font size */
            padding: 8px 10px; /* Reduced padding */
            background-color: var(--tertiary-color);
        }
        #current-date-btn:hover {
            background-color: var(--primary-color);
        }

        .calendar-popup-wrapper {
            position: relative;
        }
        .calendar-popup {
            display: none;
            position: absolute;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px; /* Reduced padding */
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 280px; /* Adjusted width */
            top: 100%;
            right: 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px; /* Reduced gap */
            text-align: center;
        }
        .calendar-grid div {
            padding: 6px; /* Reduced padding */
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.85em; /* Reduced font size */
        }
        .calendar-grid .day-name {
            font-weight: bold;
            color: var(--primary-color);
            cursor: default;
            font-size: 0.8em;
        }
        .calendar-grid .day:hover {
            background-color: var(--tertiary-color);
        }
        .calendar-grid .day.has-purchase {
            background-color: var(--primary-color) !important;
            color: white;
        }
        .calendar-grid .day.selected-day {
            outline: 2px solid var(--text-color);
            outline-offset: -2px;
        }
         .calendar-grid .day.other-month {
            color: var(--disabled-color);
            cursor: default;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Reduced margin */
        }
        .calendar-header button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.4em;
            padding: 0 5px;
        }
        .calendar-header h3 {
            font-size: 1em; /* Reduced font size */
            color: var(--text-color);
        }

        /* Compact Purchase Item Row */
        .purchase-item {
            display: flex;
            align-items: center;
            gap: 5px; /* Reduced gap */
            padding: 8px 0; /* Reduced padding */
            border-bottom: 1px solid var(--border-color);
        }
        .purchase-item:last-child {
            border-bottom: none;
        }
        .purchase-item input[type="number"] { /* Value */
            flex: 0 1 70px; /* grow 0, shrink 1, basis 70px */
            min-width: 60px; /* Minimum width before it gets too small */
            padding: 6px 8px; /* Reduced padding */
        }
        .purchase-item input[list="category-list-input-datalist"] { /* Category */
            flex: 1 1 100px; /* grow 1, shrink 1, basis 100px */
            min-width: 80px; /* Minimum width */
            padding: 6px 8px;
        }
        .purchase-item .delete-item-btn {
            flex: 0 0 auto; /* Don't grow, don't shrink */
            background-color: var(--danger-color);
            padding: 7px 10px; /* Adjusted padding */
            font-size: 0.9em;
        }
         .purchase-item .delete-item-btn:hover {
            background-color: var(--danger-hover-color);
        }

        #purchase-list-container {
            background-color: var(--secondary-color);
            padding: 10px; /* Reduced padding */
            border-radius: 5px;
            margin-bottom: 15px;
            min-height: 40px;
        }
        .no-items-message {
            color: var(--disabled-color);
            text-align: center;
            padding: 10px 0;
            font-size: 0.9em;
        }

        .purchases-actions {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .purchases-actions button {
            flex-grow: 1;
            font-size: 0.95em; /* Slightly smaller button text */
            padding: 8px 12px;
        }
        #add-purchase-item-btn {
            background-color: var(--tertiary-color);
        }
         #add-purchase-item-btn:hover {
            background-color: var(--primary-color);
        }


        /* --- Categories Page --- */
        .category-list-item {
            padding: 10px 12px; /* Reduced padding */
            font-size: 0.95em;
        }
        .category-list-item input[type="text"] {
            padding: 4px 0;
        }
        .category-list-item button {
            padding: 5px 8px; /* Reduced padding */
            font-size: 0.85em;
        }

        .category-add-form {
            padding: 12px; /* Reduced padding */
            margin-bottom: 20px;
        }

        /* --- Stats Page --- */
        .stats-nav {
            margin-bottom: 15px;
        }
        .stats-nav button {
            margin-right: 8px;
            font-size: 0.95em;
        }
        .stats-content {
            padding: 12px; /* Reduced padding */
        }
        .category-stat-item {
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .category-stat-name {
            width: 120px; /* Adjusted width */
        }
        .percentage-bar-container {
            height: 20px; /* Adjusted height */
        }
        .percentage-bar {
            font-size: 0.75em; /* Reduced font size */
        }
        .category-stat-total {
            width: 85px; /* Adjusted width */
            font-size: 0.95em;
        }
        .time-filter {
            margin-bottom: 15px;
            gap: 8px;
        }
        .time-filter label, .time-filter select {
            font-size: 0.9em;
        }
        #stats-content h3 {
            font-size: 1.15em;
        }


        #pie-chart-container {
            max-width: 300px; /* Reduced max size */
            height: 300px;
        }

        /* --- Main Calendar Page --- */
        #main-calendar-page-container .calendar-grid {
            height: calc(100vh - 180px); /* Adjusted height */
        }

        /* Further Mobile Compactness (overriding general responsive if any) */
        @media (max-width: 400px) { /* Stricter rules for very small screens */
            .app-name {
                font-size: 1.2em;
            }
            .app-logo {
                width: 24px;
                height: 24px;
            }
            .nav-toggle {
                 margin-right: 5px;
            }
            .app-name-container {
                margin-right: 30px; /* Reduce further for very small screens */
            }
            .purchases-header h2 {
                font-size: 1.15em;
            }
            #current-date-btn {
                font-size: 0.9em;
            }
            .purchase-item input[type="number"] {
                flex-basis: 60px;
                min-width: 50px;
            }
            .purchase-item input[list="category-list-input-datalist"] {
                flex-basis: 80px;
                min-width: 70px;
            }
             .main-content {
                padding-left: 10px;
                padding-right: 10px;
            }
        }

    </style>
</head>
<body>

    <header class="app-header">
        <button class="nav-toggle" id="navToggleBtn" aria-label="Vaihda navigointia">&#9776;</button>
        <div class="app-name-container">
            <svg class="app-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" rx="20" ry="20" fill="#4CAF50"/>
                <text x="50" y="65" font-size="50" fill="white" text-anchor="middle" font-family="Arial, sans-serif">P</text>
            </svg>
            <div class="app-name" id="appTitle">PossuPlan</div>
        </div>
    </header>

    <nav class="nav-bar" id="navBar">
        <ul>
            <li><a href="#" class="nav-link active" data-page="purchases">Ostokset</a></li>
            <li><a href="#" class="nav-link" data-page="calendar">Kalenteri</a></li>
            <li><a href="#" class="nav-link" data-page="categories">Kategoriat</a></li>
            <li><a href="#" class="nav-link" data-page="stats">Tilastot</a></li>
        </ul>
    </nav>

    <main class="main-content" id="mainContent">
        <section id="purchases" class="page active">
            <div class="purchases-header">
                <h2 id="purchases-page-title">Tämän päivän ostokset</h2>
                <div class="calendar-popup-wrapper">
                    <button id="current-date-btn">8. toukokuuta 2025</button>
                    <div id="calendar-popup" class="calendar-popup">
                        <div class="calendar-header">
                            <button id="popup-prev-month-btn">&lt;</button>
                            <h3 id="popup-current-month-year">Toukokuu 2025</h3>
                            <button id="popup-next-month-btn">&gt;</button>
                        </div>
                        <div class="calendar-grid" id="popup-calendar-grid">
                            </div>
                    </div>
                </div>
            </div>

            <div id="purchase-list-container">
                </div>
            <datalist id="category-list-input-datalist">
                </datalist>

            <div class="purchases-actions">
                <button id="save-purchases-btn">Tallenna ostokset</button>
                <button id="add-purchase-item-btn">Lisää rivi</button>
            </div>
        </section>

        <section id="calendar" class="page">
            <div id="main-calendar-page-container">
                <h2>Kalenterinäkymä</h2>
                <div class="calendar-header">
                    <button id="main-prev-month-btn">&lt;</button>
                    <h3 id="main-current-month-year">Toukokuu 2025</h3>
                    <button id="main-next-month-btn">&gt;</button>
                </div>
                <div class="calendar-grid" id="main-calendar-grid">
                    </div>
            </div>
        </section>

        <section id="categories" class="page">
            <h2>Hallitse kategorioita</h2>
            <div class="category-add-form">
                <input type="text" id="new-category-name-input" placeholder="Kirjoita uusi kategoria tai etsi" list="category-suggestions-list-datalist">
                <datalist id="category-suggestions-list-datalist">
                    </datalist>
                <button id="add-new-category-btn">Lisää/Valitse kategoria</button>
            </div>
            <ul id="category-manager-list">
                </ul>
        </section>

        <section id="stats" class="page">
            <h2>Tilastot</h2>
            <div class="stats-nav">
                <button id="stats-categories-btn" class="active" data-view="categories">Kategoriat</button>
                <button id="stats-graph-btn" data-view="graph">Kaavio</button>
            </div>
            <div class="stats-content">
                <div class="time-filter">
                     <label for="stats-time-filter">Ajanjakso:</label>
                    <select id="stats-time-filter">
                        <option value="week" selected>Tämä viikko</option>
                        <option value="month">Tämä kuukausi</option>
                        <option value="year">Tämä vuosi</option>
                        <option value="all">Kaikki ajat</option>
                    </select>
                </div>
                <div id="stats-categories-view">
                    <h3 style="margin-bottom: 15px;">Suosituimmat kategoriat (kulutus)</h3>
                    <div id="top-categories-list">
                        </div>
                </div>
                <div id="stats-graph-view" style="display: none;">
                    <h3 style="margin-bottom: 15px; text-align:center;">Kulujakauma</h3>
                     <div id="pie-chart-container">
                        </div>
                </div>
            </div>
        </section>
    </main>
    <div class="pie-tooltip" id="pieTooltip"></div>


    <script>
        // --- Polyfills and Helpers ---
        Date.prototype.yyyymmdd = function() {
            const mm = this.getMonth() + 1; // getMonth() is zero-based
            const dd = this.getDate();
            return [this.getFullYear(),
                    (mm>9 ? '' : '0') + mm,
                    (dd>9 ? '' : '0') + dd
                   ].join('-');
        };

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function formatCurrency(value) {
            return value.toLocaleString('fi-FI', { style: 'currency', currency: 'EUR' });
        }

        const ELS = { // Global DOM Elements Object
            navToggleBtn: document.getElementById('navToggleBtn'),
            navBar: document.getElementById('navBar'),
            appTitleDisplay: document.getElementById('appTitle'), // Changed from appTitle to avoid conflict
            navLinks: document.querySelectorAll('.nav-link'),
            pages: document.querySelectorAll('.page'),

            // Purchases Page
            purchasesPageTitle: document.getElementById('purchases-page-title'),
            currentDateBtn: document.getElementById('current-date-btn'),
            calendarPopup: document.getElementById('calendar-popup'),
            popupCalendarGrid: document.getElementById('popup-calendar-grid'),
            popupCurrentMonthYear: document.getElementById('popup-current-month-year'),
            popupPrevMonthBtn: document.getElementById('popup-prev-month-btn'),
            popupNextMonthBtn: document.getElementById('popup-next-month-btn'),
            purchaseListContainer: document.getElementById('purchase-list-container'),
            categoryDatalist: document.getElementById('category-list-input-datalist'),
            addPurchaseItemBtn: document.getElementById('add-purchase-item-btn'),
            savePurchasesBtn: document.getElementById('save-purchases-btn'),

            // Calendar Page
            mainCalendarGrid: document.getElementById('main-calendar-grid'),
            mainCurrentMonthYear: document.getElementById('main-current-month-year'),
            mainPrevMonthBtn: document.getElementById('main-prev-month-btn'),
            mainNextMonthBtn: document.getElementById('main-next-month-btn'),

            // Categories Page
            newCategoryNameInput: document.getElementById('new-category-name-input'),
            categorySuggestionsDatalist: document.getElementById('category-suggestions-list-datalist'),
            addNewCategoryBtn: document.getElementById('add-new-category-btn'),
            categoryManagerList: document.getElementById('category-manager-list'),

            // Stats Page
            statsCategoriesBtn: document.getElementById('stats-categories-btn'),
            statsGraphBtn: document.getElementById('stats-graph-btn'),
            statsCategoriesView: document.getElementById('stats-categories-view'),
            statsGraphView: document.getElementById('stats-graph-view'),
            topCategoriesList: document.getElementById('top-categories-list'),
            statsTimeFilter: document.getElementById('stats-time-filter'),
            pieChartContainer: document.getElementById('pie-chart-container'),
            pieTooltip: document.getElementById('pieTooltip'),
        };

        const FINNISH_TEXTS = {
            purchases: "Ostokset",
            calendar: "Kalenteri",
            categories: "Kategoriat",
            stats: "Tilastot",
            defaultCategories: [
                { name: 'Ruokaostokset' }, { name: 'Liikenne' }, { name: 'Viihde' },
                { name: 'Laskut' }, { name: 'Asuminen' }, { name: 'Terveys' }
            ],
            dayNamesShort: ['Ma', 'Ti', 'Ke', 'To', 'Pe', 'La', 'Su'],
            alertCategoryExists: (name) => `Kategoria "${name}" on jo olemassa.`,
            alertPurchasesSaved: "Ostokset tallennettu!",
            noPurchasesMessage: "Ei ostoksia tälle päivälle. Lisää uusi!",
            noStatsDataMessage: "Ei kulutustietoja valitulle ajanjaksolle.",
            placeholderCategory: "Valitse/kirjoita kategoria",
            deleteButtonText: "Poista",
            todayPurchasesTitle: "Tämän päivän ostokset",
            purchasesForDateTitle: (dateStr) => `Ostokset päivälle ${dateStr}`,
        };


        // --- App State ---
        let state = {
            currentViewDate: new Date(2025, 4, 8), // May 8, 2025 - Month is 0-indexed
            popupCalendarDate: new Date(2025, 4, 8),
            mainCalendarDate: new Date(2025, 4, 8),
            purchases: [],
            categories: [],
        };

        const DB_PURCHASES_KEY = 'possuPlanPurchases_v2_fi'; // new key for lang version
        const DB_CATEGORIES_KEY = 'possuPlanCategories_v2_fi';
        const DATE_OPTIONS_FI_LONG = { year: 'numeric', month: 'long', day: 'numeric', locale: 'fi-FI' };
        const DATE_OPTIONS_FI_NUMERIC = { year: 'numeric', month: 'numeric', day: 'numeric', locale: 'fi-FI' };
        const DATE_OPTIONS_FI_MONTH_YEAR = { month: 'long', year: 'numeric', locale: 'fi-FI' };


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updatePurchasesPageDateElements(state.currentViewDate);
            renderPurchasesForDate(state.currentViewDate.yyyymmdd());
            updateCategoryDatalists();
            renderCategoryManagerList();
            renderCalendar(ELS.popupCalendarGrid, state.popupCalendarDate, ELS.popupCurrentMonthYear, handlePopupDayClick, true);
            renderCalendar(ELS.mainCalendarGrid, state.mainCalendarDate, ELS.mainCurrentMonthYear, handleMainCalendarDayClick, false);
            setupEventListeners();
            updateStats();
        });

        function setupEventListeners() {
            ELS.navToggleBtn.addEventListener('click', toggleNav);
            ELS.navLinks.forEach(link => link.addEventListener('click', handleNavClick));

            ELS.currentDateBtn.addEventListener('click', toggleCalendarPopup);
            document.addEventListener('click', closePopupIfClickedOutside);
            ELS.popupPrevMonthBtn.addEventListener('click', () => changeCalendarMonth(-1, 'popup'));
            ELS.popupNextMonthBtn.addEventListener('click', () => changeCalendarMonth(1, 'popup'));
            ELS.addPurchaseItemBtn.addEventListener('click', () => addPurchaseRowToDOM(null, true));
            ELS.savePurchasesBtn.addEventListener('click', saveCurrentDayPurchases);

            ELS.mainPrevMonthBtn.addEventListener('click', () => changeCalendarMonth(-1, 'main'));
            ELS.mainNextMonthBtn.addEventListener('click', () => changeCalendarMonth(1, 'main'));

            ELS.newCategoryNameInput.addEventListener('input', populateCategorySuggestions);
            ELS.addNewCategoryBtn.addEventListener('click', handleAddOrSelectCategory);

            ELS.statsCategoriesBtn.addEventListener('click', () => switchStatsView('categories'));
            ELS.statsGraphBtn.addEventListener('click', () => switchStatsView('graph'));
            ELS.statsTimeFilter.addEventListener('change', updateStats);
        }

        // --- Data Persistence ---
        function loadData() {
            const storedPurchases = localStorage.getItem(DB_PURCHASES_KEY);
            state.purchases = storedPurchases ? JSON.parse(storedPurchases) : [];

            const storedCategories = localStorage.getItem(DB_CATEGORIES_KEY);
            if (storedCategories) {
                state.categories = JSON.parse(storedCategories);
            } else {
                state.categories = FINNISH_TEXTS.defaultCategories.map(cat => ({
                    id: generateId(), name: cat.name, isHidden: false
                }));
                saveCategories();
            }
        }

        function savePurchases() {
            localStorage.setItem(DB_PURCHASES_KEY, JSON.stringify(state.purchases));
        }
        function saveCategories() {
            localStorage.setItem(DB_CATEGORIES_KEY, JSON.stringify(state.categories));
            updateCategoryDatalists();
            renderCategoryManagerList();
            updateStats();
        }

        // --- Navigation ---
        function toggleNav() {
            ELS.navBar.classList.toggle('open');
        }
        function handleNavClick(e) {
            e.preventDefault();
            const targetPageId = e.target.getAttribute('data-page');
            activatePage(targetPageId);
            ELS.navLinks.forEach(nav => nav.classList.remove('active'));
            e.target.classList.add('active');
            // App title is static "PossuPlan"
            if (ELS.navBar.classList.contains('open')) {
                toggleNav();
            }
        }
        function activatePage(pageId) {
            ELS.pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            if (pageId === 'categories') renderCategoryManagerList();
            if (pageId === 'calendar') {
                state.mainCalendarDate = new Date(state.currentViewDate);
                renderCalendar(ELS.mainCalendarGrid, state.mainCalendarDate, ELS.mainCurrentMonthYear, handleMainCalendarDayClick, false);
            }
            if (pageId === 'stats') updateStats();
            if (pageId === 'purchases') {
                renderPurchasesForDate(state.currentViewDate.yyyymmdd());
            }
        }

        // --- Purchases Page ---
        function updatePurchasesPageDateElements(date) {
            ELS.currentDateBtn.textContent = date.toLocaleDateString('fi-FI', DATE_OPTIONS_FI_LONG);
            const today = new Date();
            today.setHours(0,0,0,0); // Normalize today for comparison
            const viewDateNormalized = new Date(date);
            viewDateNormalized.setHours(0,0,0,0);

            if (viewDateNormalized.getTime() === today.getTime()) {
                ELS.purchasesPageTitle.textContent = FINNISH_TEXTS.todayPurchasesTitle;
            } else {
                ELS.purchasesPageTitle.textContent = FINNISH_TEXTS.purchasesForDateTitle(date.toLocaleDateString('fi-FI', DATE_OPTIONS_FI_NUMERIC));
            }
        }

        function toggleCalendarPopup(event) {
            event.stopPropagation();
            const isVisible = ELS.calendarPopup.style.display === 'block';
            if (isVisible) {
                ELS.calendarPopup.style.display = 'none';
            } else {
                state.popupCalendarDate = new Date(state.currentViewDate);
                renderCalendar(ELS.popupCalendarGrid, state.popupCalendarDate, ELS.popupCurrentMonthYear, handlePopupDayClick, true);
                ELS.calendarPopup.style.display = 'block';
            }
        }

        function closePopupIfClickedOutside(event) {
            if (ELS.calendarPopup.style.display === 'block' &&
                !ELS.calendarPopup.contains(event.target) &&
                event.target !== ELS.currentDateBtn) {
                ELS.calendarPopup.style.display = 'none';
            }
        }

        function changeCalendarMonth(monthOffset, calendarType) {
            const targetDate = calendarType === 'popup' ? state.popupCalendarDate : state.mainCalendarDate;
            targetDate.setMonth(targetDate.getMonth() + monthOffset);
            if (calendarType === 'popup') {
                renderCalendar(ELS.popupCalendarGrid, targetDate, ELS.popupCurrentMonthYear, handlePopupDayClick, true);
            } else {
                renderCalendar(ELS.mainCalendarGrid, targetDate, ELS.mainCurrentMonthYear, handleMainCalendarDayClick, false);
            }
        }

        function renderCalendar(gridElement, dateToDisplay, monthYearElement, dayClickHandler, isPopup) {
            gridElement.innerHTML = '';
            monthYearElement.textContent = dateToDisplay.toLocaleDateString('fi-FI', DATE_OPTIONS_FI_MONTH_YEAR);

            const year = dateToDisplay.getFullYear();
            const month = dateToDisplay.getMonth();
            const firstDayOfMonthDate = new Date(year, month, 1);
            // Adjust for Monday start: getDay() returns 0 for Sun, 1 for Mon. We want Mon=0, Tue=1 .. Sun=6
            const firstDayOfMonthIndex = (firstDayOfMonthDate.getDay() === 0) ? 6 : firstDayOfMonthDate.getDay() - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            FINNISH_TEXTS.dayNamesShort.forEach(name => {
                const dayNameEl = document.createElement('div');
                dayNameEl.classList.add('day-name');
                dayNameEl.textContent = name;
                gridElement.appendChild(dayNameEl);
            });

            const purchasesByDate = {};
            state.purchases.forEach(p => purchasesByDate[p.date] = true);

            for (let i = 0; i < firstDayOfMonthIndex; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day', 'other-month');
                dayEl.textContent = daysInPrevMonth - firstDayOfMonthIndex + 1 + i;
                gridElement.appendChild(dayEl);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                dayEl.textContent = day;
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.yyyymmdd();
                dayEl.dataset.date = dateString;

                if (purchasesByDate[dateString]) {
                    dayEl.classList.add('has-purchase');
                }
                if (isPopup && dateString === state.currentViewDate.yyyymmdd()) {
                    dayEl.classList.add('selected-day');
                }
                dayEl.addEventListener('click', () => dayClickHandler(currentDate));
                gridElement.appendChild(dayEl);
            }

            const totalCells = firstDayOfMonthIndex + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remainingCells; i++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day', 'other-month');
                dayEl.textContent = i;
                gridElement.appendChild(dayEl);
            }
        }

        function handlePopupDayClick(date) {
            state.currentViewDate = date;
            updatePurchasesPageDateElements(date);
            renderPurchasesForDate(date.yyyymmdd());
            ELS.calendarPopup.style.display = 'none';
            renderCalendar(ELS.popupCalendarGrid, state.popupCalendarDate, ELS.popupCurrentMonthYear, handlePopupDayClick, true);
        }

        function renderPurchasesForDate(dateString) {
            ELS.purchaseListContainer.innerHTML = '';
            const itemsForDate = state.purchases.filter(p => p.date === dateString);
            if (itemsForDate.length === 0) {
                ELS.purchaseListContainer.innerHTML = `<p class="no-items-message">${FINNISH_TEXTS.noPurchasesMessage}</p>`;
            } else {
                itemsForDate.forEach(item => addPurchaseRowToDOM(item, false));
            }
            updateCategoryDatalists();
        }

        function addPurchaseRowToDOM(itemData, isNew) {
            const noItemsMsg = ELS.purchaseListContainer.querySelector('.no-items-message');
            if (noItemsMsg) noItemsMsg.remove();

            const itemDiv = document.createElement('div');
            itemDiv.classList.add('purchase-item');
            const itemId = itemData ? itemData.id : generateId();
            itemDiv.dataset.itemId = itemId;

            const valueInput = document.createElement('input');
            valueInput.type = 'number';
            valueInput.placeholder = '0,00'; // Finnish placeholder
            valueInput.min = "0.01";
            valueInput.step = "0.01";
            valueInput.value = itemData ? itemData.value : '';
            valueInput.setAttribute('aria-label', 'Summa');

            const categoryInput = document.createElement('input');
            categoryInput.type = 'text';
            categoryInput.setAttribute('list', ELS.categoryDatalist.id);
            categoryInput.placeholder = FINNISH_TEXTS.placeholderCategory;
            const categoryName = itemData?.categoryId ? (state.categories.find(c => c.id === itemData.categoryId)?.name || '') : '';
            categoryInput.value = categoryName;
            categoryInput.dataset.categoryId = itemData?.categoryId || '';

            categoryInput.addEventListener('input', (e) => {
                const inputValue = e.target.value.toLowerCase();
                updateCategoryDatalists(inputValue);
                const matchedOption = Array.from(ELS.categoryDatalist.options).find(opt => opt.value.toLowerCase() === inputValue);
                e.target.dataset.categoryId = matchedOption ? matchedOption.dataset.id : '';
            });
             categoryInput.addEventListener('change', (e) => {
                const chosenOption = Array.from(ELS.categoryDatalist.options).find(opt => opt.value === e.target.value);
                if (chosenOption) {
                    e.target.dataset.categoryId = chosenOption.dataset.id;
                }
                updateCategoryDatalists();
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = FINNISH_TEXTS.deleteButtonText;
            deleteBtn.classList.add('delete-item-btn');
            deleteBtn.onclick = () => {
                itemDiv.remove();
                if (ELS.purchaseListContainer.children.length === 0) {
                    ELS.purchaseListContainer.innerHTML = `<p class="no-items-message">${FINNISH_TEXTS.noPurchasesMessage}</p>`;
                }
            };

            itemDiv.appendChild(valueInput);
            itemDiv.appendChild(categoryInput);
            itemDiv.appendChild(deleteBtn);
            ELS.purchaseListContainer.appendChild(itemDiv);
            if (isNew) valueInput.focus();
        }

        function saveCurrentDayPurchases() {
            const dateString = state.currentViewDate.yyyymmdd();
            state.purchases = state.purchases.filter(p => p.date !== dateString);
            let newCategoriesAdded = false;

            ELS.purchaseListContainer.querySelectorAll('.purchase-item').forEach(itemEl => {
                const valueStr = itemEl.querySelector('input[type="number"]').value.replace(',', '.'); // Handle , as decimal for input
                const value = parseFloat(valueStr);
                const categoryInputEl = itemEl.querySelector('input[list="' + ELS.categoryDatalist.id + '"]');
                const categoryName = categoryInputEl.value.trim();
                let categoryId = categoryInputEl.dataset.categoryId;

                if (!isNaN(value) && value > 0 && categoryName) {
                    if (!categoryId) {
                        let existingCategory = state.categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                        if (existingCategory) {
                            categoryId = existingCategory.id;
                        } else {
                            const newCategory = { id: generateId(), name: categoryName, isHidden: false };
                            state.categories.push(newCategory);
                            categoryId = newCategory.id;
                            newCategoriesAdded = true;
                        }
                    }
                    state.purchases.push({
                        id: itemEl.dataset.itemId, date: dateString, value: value, categoryId: categoryId
                    });
                }
            });

            savePurchases();
            if (newCategoriesAdded) saveCategories();
            //alert(FINNISH_TEXTS.alertPurchasesSaved);
            renderPurchasesForDate(dateString);
            renderCalendar(ELS.popupCalendarGrid, state.popupCalendarDate, ELS.popupCurrentMonthYear, handlePopupDayClick, true);
            renderCalendar(ELS.mainCalendarGrid, state.mainCalendarDate, ELS.mainCurrentMonthYear, handleMainCalendarDayClick, false);
            updateStats();
        }

        function updateCategoryDatalists(filterText = '') {
            ELS.categoryDatalist.innerHTML = '';
            ELS.categorySuggestionsDatalist.innerHTML = '';
            const lcFilter = filterText.toLowerCase();
            const relevantCategories = state.categories.filter(cat => !cat.isHidden && (filterText === '' || cat.name.toLowerCase().includes(lcFilter)));
            relevantCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.dataset.id = cat.id;
                ELS.categoryDatalist.appendChild(option.cloneNode(true));
                ELS.categorySuggestionsDatalist.appendChild(option);
            });
        }

        // --- Main Calendar Page ---
        function handleMainCalendarDayClick(date) {
            state.currentViewDate = date;
            updatePurchasesPageDateElements(date);
            activatePage('purchases');
        }

        // --- Categories Page ---
        function populateCategorySuggestions() {
            const inputText = ELS.newCategoryNameInput.value.toLowerCase();
            ELS.categorySuggestionsDatalist.innerHTML = '';
            if (inputText.length > 0) {
                const filtered = state.categories.filter(c => c.name.toLowerCase().includes(inputText));
                filtered.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.dataset.id = cat.id;
                    ELS.categorySuggestionsDatalist.appendChild(option);
                });
            }
        }

        function handleAddOrSelectCategory() {
            const newName = ELS.newCategoryNameInput.value.trim();
            if (!newName) return;
            const existingOption = Array.from(ELS.categorySuggestionsDatalist.options).find(opt => opt.value === newName);
            if (existingOption) {
                ELS.newCategoryNameInput.value = '';
                ELS.categorySuggestionsDatalist.innerHTML = '';
                const listItem = ELS.categoryManagerList.querySelector(`li[data-category-id="${existingOption.dataset.id}"]`);
                if(listItem) listItem.scrollIntoView({behavior: "smooth", block: "center"});
                return;
            }
            if (state.categories.some(c => c.name.toLowerCase() === newName.toLowerCase())) {
                alert(FINNISH_TEXTS.alertCategoryExists(newName));
                return;
            }
            const newCategory = { id: generateId(), name: newName, isHidden: false };
            state.categories.push(newCategory);
            saveCategories();
            ELS.newCategoryNameInput.value = '';
            ELS.categorySuggestionsDatalist.innerHTML = '';
        }

        function renderCategoryManagerList() {
            ELS.categoryManagerList.innerHTML = '';
            state.categories.sort((a,b) => a.name.localeCompare(b.name, 'fi')).forEach(cat => {
                const li = document.createElement('li');
                li.classList.add('category-list-item');
                li.classList.toggle('hidden-category', cat.isHidden);
                li.dataset.categoryId = cat.id;

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = cat.name;
                nameInput.setAttribute('aria-label', `Kategorian nimi: ${cat.name}`);
                nameInput.addEventListener('change', () => {
                    const updatedName = nameInput.value.trim();
                    if (updatedName && updatedName !== cat.name) {
                        if (state.categories.some(c => c.name.toLowerCase() === updatedName.toLowerCase() && c.id !== cat.id)) {
                            alert(FINNISH_TEXTS.alertCategoryExists(updatedName));
                            nameInput.value = cat.name;
                            return;
                        }
                        cat.name = updatedName;
                        saveCategories();
                    } else if (!updatedName) {
                        nameInput.value = cat.name;
                    }
                });

                const hideBtn = document.createElement('button');
                hideBtn.textContent = cat.isHidden ? 'Näytä' : 'Piilota';
                hideBtn.setAttribute('aria-label', `${cat.isHidden ? 'Näytä' : 'Piilota'} kategoria ${cat.name}`);
                hideBtn.onclick = () => {
                    cat.isHidden = !cat.isHidden;
                    saveCategories();
                };
                li.appendChild(nameInput);
                li.appendChild(hideBtn);
                ELS.categoryManagerList.appendChild(li);
            });
        }

        // --- Stats Page ---
        function switchStatsView(view) {
            ELS.statsCategoriesView.style.display = (view === 'categories') ? 'block' : 'none';
            ELS.statsGraphView.style.display = (view === 'graph') ? 'block' : 'none';
            ELS.statsCategoriesBtn.classList.toggle('active', view === 'categories');
            ELS.statsGraphBtn.classList.toggle('active', view === 'graph');
            updateStats();
        }

        function getFilteredPurchasesForStats() {
            const timeFilter = ELS.statsTimeFilter.value;
            const now = new Date();
            let startDate = new Date(now); // Clone 'now'

            switch (timeFilter) {
                case 'week':
                    const currentDay = startDate.getDay(); // 0 (Sun) to 6 (Sat)
                    const diff = startDate.getDate() - currentDay + (currentDay === 0 ? -6 : 1); // Adjust to Monday
                    startDate.setDate(diff);
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                default:
                    return state.purchases;
            }
            return state.purchases.filter(p => new Date(p.date + "T00:00:00") >= startDate);
        }

        function updateStats() {
            if (!document.getElementById('stats').classList.contains('active')) return;
            const filteredPurchases = getFilteredPurchasesForStats();
            const categoryTotals = {};
            let grandTotalSpent = 0;

            filteredPurchases.forEach(p => {
                if (!p.categoryId) return;
                const category = state.categories.find(c => c.id === p.categoryId);
                if (category && !category.isHidden) {
                    categoryTotals[p.categoryId] = (categoryTotals[p.categoryId] || 0) + p.value;
                    grandTotalSpent += p.value;
                }
            });

            const sortedCategories = Object.entries(categoryTotals)
                .map(([categoryId, total]) => ({
                    id: categoryId,
                    name: state.categories.find(c => c.id === categoryId)?.name || 'Tuntematon kategoria',
                    total: total,
                }))
                .sort((a, b) => b.total - a.total);

            if (ELS.statsCategoriesView.style.display !== 'none') {
                renderStatsCategoryList(sortedCategories.slice(0, 10), grandTotalSpent);
            }
            if (ELS.statsGraphView.style.display !== 'none') {
                renderPieChart(sortedCategories, grandTotalSpent);
            }
        }

        function renderStatsCategoryList(topCategoriesData, overallTotal) {
            ELS.topCategoriesList.innerHTML = '';
            if (topCategoriesData.length === 0) {
                ELS.topCategoriesList.innerHTML = `<p class="no-items-message">${FINNISH_TEXTS.noStatsDataMessage}</p>`;
                return;
            }
            topCategoriesData.forEach(cat => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('category-stat-item');
                const nameEl = document.createElement('div');
                nameEl.classList.add('category-stat-name');
                nameEl.textContent = cat.name;
                nameEl.title = cat.name;
                const barContainer = document.createElement('div');
                barContainer.classList.add('percentage-bar-container');
                const percentage = overallTotal > 0 ? (cat.total / overallTotal) * 100 : 0;
                const barEl = document.createElement('div');
                barEl.classList.add('percentage-bar');
                setTimeout(() => { barEl.style.width = `${Math.max(0, Math.min(100, percentage))}%`; }, 10);
                barEl.textContent = `${percentage.toFixed(1)}%`;
                const totalEl = document.createElement('div');
                totalEl.classList.add('category-stat-total');
                totalEl.textContent = formatCurrency(cat.total);
                barContainer.appendChild(barEl);
                itemEl.appendChild(nameEl);
                itemEl.appendChild(barContainer);
                itemEl.appendChild(totalEl);
                ELS.topCategoriesList.appendChild(itemEl);
            });
        }
        const PIE_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#8CD17D', '#F0A3A3', '#A3C2F0', '#787878', '#C1A0C1'];

        function renderPieChart(allCategoryData, grandTotal) {
            ELS.pieChartContainer.innerHTML = '';
            ELS.pieTooltip.style.display = 'none';
            if (grandTotal === 0 || allCategoryData.length === 0) {
                ELS.pieChartContainer.innerHTML = `<p class="no-items-message" style="text-align:center; padding-top:50px;">${FINNISH_TEXTS.noStatsDataMessage}</p>`;
                return;
            }
            const chartData = [];
            let otherTotal = 0;
            if (allCategoryData.length > 10) {
                for(let i=0; i < 9; i++) chartData.push(allCategoryData[i]);
                for(let i=9; i < allCategoryData.length; i++) otherTotal += allCategoryData[i].total;
                if (otherTotal > 0) chartData.push({ name: 'Muut', total: otherTotal });
            } else {
                chartData.push(...allCategoryData);
            }

            const radius = Math.min(ELS.pieChartContainer.offsetWidth, ELS.pieChartContainer.offsetHeight) / 2 * 0.85;
            const centerX = ELS.pieChartContainer.offsetWidth / 2;
            const centerY = ELS.pieChartContainer.offsetHeight / 2;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", ELS.pieChartContainer.offsetWidth);
            svg.setAttribute("height", ELS.pieChartContainer.offsetHeight);
            svg.setAttribute("viewBox", `0 0 ${ELS.pieChartContainer.offsetWidth} ${ELS.pieChartContainer.offsetHeight}`);
            ELS.pieChartContainer.appendChild(svg);
            let currentAngle = -90;

            chartData.forEach((slice, index) => {
                const percentage = slice.total / grandTotal;
                const angle = percentage * 360;
                const path = document.createElementNS(svgNS, "path");
                const x1 = centerX + radius * Math.cos(currentAngle * Math.PI / 180);
                const y1 = centerY + radius * Math.sin(currentAngle * Math.PI / 180);
                currentAngle += angle;
                const x2 = centerX + radius * Math.cos(currentAngle * Math.PI / 180);
                const y2 = centerY + radius * Math.sin(currentAngle * Math.PI / 180);
                const largeArcFlag = angle > 180 ? 1 : 0;
                const d = [`M ${centerX},${centerY}`, `L ${x1},${y1}`, `A ${radius},${radius} 0 ${largeArcFlag} 1 ${x2},${y2}`, "Z"].join(" ");
                path.setAttribute("d", d);
                path.setAttribute("fill", PIE_COLORS[index % PIE_COLORS.length]);
                path.setAttribute("stroke", getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim());
                path.setAttribute("stroke-width", "2");
                const title = document.createElementNS(svgNS, "title");
                title.textContent = `${slice.name}: ${formatCurrency(slice.total)} (${(percentage * 100).toFixed(1)}%)`;
                path.appendChild(title);
                path.addEventListener('mousemove', (e) => {
                    ELS.pieTooltip.style.display = 'block';
                    ELS.pieTooltip.innerHTML = title.textContent;
                    let x = e.clientX + 15; let y = e.clientY + 15;
                    if (x + ELS.pieTooltip.offsetWidth > window.innerWidth) x = e.clientX - ELS.pieTooltip.offsetWidth - 15;
                    if (y + ELS.pieTooltip.offsetHeight > window.innerHeight) y = e.clientY - ELS.pieTooltip.offsetHeight - 15;
                    ELS.pieTooltip.style.left = x + 'px'; ELS.pieTooltip.style.top = y + 'px';
                });
                path.addEventListener('mouseout', () => { ELS.pieTooltip.style.display = 'none'; });
                svg.appendChild(path);
            });
        }
    </script>
</body>
</html>